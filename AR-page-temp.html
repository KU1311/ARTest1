<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<title>油旺區健康城市建議 - 擴闊行人路想像 AR體驗</title>
	<!-- include three.js library -->
	<script src='js/three.js'></script>
	<script src='js/OBJLoader.js'></script>
	<script src='js/MTLLoader.js'></script>
	<!-- include jsartoolkit -->
	<script src="jsartoolkit5/artoolkit.min.js"></script>
	<script src="jsartoolkit5/artoolkit.api.js"></script>
	<!-- include threex.artoolkit -->
	<script src="threex/threex-artoolkitsource.js"></script>
	<script src="threex/threex-artoolkitcontext.js"></script>
	<script src="threex/threex-arbasecontrols.js"></script>
	<script src="threex/threex-armarkercontrols.js"></script>
	<style>
		html, body {
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
		#cameraView {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 1;
		}
		.refresh-button {
			position: fixed;
			bottom: 20px;
			right: 20px;
			background-color: #007BFF;
			color: white;
			border: none;
			border-radius: 5px;
			padding: 10px 15px;
			font-size: 16px;
			cursor: pointer;
			z-index: 1000;
		}
		.refresh-button:hover {
			background-color: #0056b3;
		}
		.title {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			background-color: rgba(255, 255, 255, 0.8);
			padding: 10px 20px;
			font-size: 24px;
			color: #333;
			z-index: 1000;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
			text-align: center;
			word-wrap: break-word;
			overflow-wrap: break-word;
		}
		.model-selector {
			position: fixed;
			top: 70px; /* Adjust this to position below the title */
			left: 50%;
			transform: translateX(-50%);
			z-index: 1000;
			background-color: white;
			border: 1px solid #ccc;
			border-radius: 5px;
			padding: 10px;
		}
	</style>
</head>

<body>

<div id="cameraView"></div>
<div class="title">
    <h3>油旺區健康城市建議 - AR體驗</h3>
    <br>您想像中的行人路是怎樣的呢?
</div>

<!-- Dropdown for model selection -->
<div class="model-selector">
	<label for="model-select">選擇模型:</label>
	<select id="model-select">
		<option value="none">無模型</option>
		<option value="newRoad">新道路</option>
		<option value="parking">停車場</option>
		<option value="parking_trees">停車場與樹木</option>
		<option value="parking_seats">停車場與座椅</option>
		<option value="seatings">座椅</option>
		<option value="seatings_trees">座椅與樹木</option>
		<option value="trees">樹木</option>
	</select>
</div>

<script>
var scene, camera, renderer, clock, deltaTime, totalTime;
var arToolkitSource, arToolkitContext;
var markerRoot1;
var models = {}; // Object to hold model references

initialize();
animate();

async function initialize() {
	scene = new THREE.Scene();
	let ambientLight = new THREE.AmbientLight(0xcccccc, 1.0);
	scene.add(ambientLight);

	camera = new THREE.Camera();
	scene.add(camera);

	renderer = new THREE.WebGLRenderer({
		antialias: true,
		alpha: true
	});
	renderer.setClearColor(new THREE.Color('lightgrey'), 0);
	renderer.setSize(window.innerWidth, window.innerHeight);
	document.getElementById('cameraView').appendChild(renderer.domElement);

	clock = new THREE.Clock();
	deltaTime = 0;
	totalTime = 0;

	arToolkitSource = new THREEx.ArToolkitSource({
		sourceType: 'webcam',
	});

	function onResize() {
		arToolkitSource.onResize();
		arToolkitSource.copySizeTo(renderer.domElement);
		if (arToolkitContext.arController !== null) {
			arToolkitSource.copySizeTo(arToolkitContext.arController.canvas);
		}
	}

	arToolkitSource.init(function onReady() {
		onResize();
	});

	window.addEventListener('resize', function () {
		onResize();
		renderer.setSize(window.innerWidth, window.innerHeight);
	});

	arToolkitContext = new THREEx.ArToolkitContext({
		cameraParametersUrl: 'data/camera_para.dat',
		detectionMode: 'mono'
	});

	arToolkitContext.init(function onCompleted() {
		camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
	});

	markerRoot1 = new THREE.Group();
	scene.add(markerRoot1);
	let markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot1, {
		type: 'pattern', patternUrl: "data/hiro.patt",
	})

	// Load all models initially
	await loadAllModels();

	// Event listener for model selection
	document.getElementById('model-select').addEventListener('change', function() {
		const selectedModel = this.value;
		updateModelVisibility(selectedModel);
	});
}

// Function to load all models
async function loadAllModels() {
	await loadModel('models/base.mtl', 'models/base.obj', 'base', true);
	await loadModel('models/cars.mtl', 'models/cars.obj', 'cars', true);
	await loadModel('models/signs-basic.mtl', 'models/signs-basic.obj', 'signs-basic', true);
	await loadModel('models/signs-old.mtl', 'models/signs-old.obj', 'signs-old', true);
	await loadModel('models/signs-new.mtl', 'models/signs-new.obj', 'signs-new', false);
	await loadModel('models/newRoad.mtl', 'models/newRoad.obj', 'newRoad', false);
	await loadModel('models/parking.mtl', 'models/parking.obj', 'parking', false);
	await loadModel('models/seats1.mtl', 'models/seats1.obj', 'seats', false);
	await loadModel('models/seats2.mtl', 'models/seats2.obj', 'seats2', false);
	await loadModel('models/bushes.mtl', 'models/bushes.obj', 'bushes', false);
	await loadModel('models/trees.mtl', 'models/trees.obj', 'trees', false);
}

// Define which models to display for each dropdown option
const modelVisibilityMap = {
    newRoad: ['newRoad', 'signs-new'],
    parking: ['newRoad', 'parking', 'bushes', 'signs-new'],
    parking_trees: ['newRoad', 'parking', 'bushes', 'trees', 'signs-new'],
    parking_seats: ['newRoad', 'parking', 'seats2', 'signs-new'],
    seatings: ['newRoad', 'seats', 'bushes', 'signs-new'],
    seatings_trees: ['newRoad', 'seats', 'bushes', 'trees', 'signs-new'],
    trees: ['newRoad', 'trees', 'signs-new'],
    none: ['signs-old']
};

// Function to load a model
function loadModel(mtlPath, objPath, modelName, isVisible) {
	return new Promise((resolve, reject) => {
		new THREE.MTLLoader()
			.setPath('models/')
			.load(mtlPath, function (materials) {
				materials.preload();
				new THREE.OBJLoader()
					.setMaterials(materials)
					.setPath('models/')
					.load(objPath, function (group) {
						models[modelName] = group.children[0];
						models[modelName].material.side = THREE.DoubleSide;
						models[modelName].position.y = 0.25;
						models[modelName].scale.set(1, 1, 1);
						models[modelName].visible = isVisible; // Set visibility
						markerRoot1.add(models[modelName]);
						resolve();
					}, onProgress, onError);
			});
	});
}

function updateModelVisibility(selectedModel) {
	// Hide all models first
	for (const model in models) {
		models[model].visible = false;
	}
	// Show the models based on the selected option
	const modelsToShow = modelVisibilityMap[selectedModel] || [];
	modelsToShow.forEach(modelName => {
		if (models[modelName]) {
			models[modelName].visible = true;
		}
	});
}

function onProgress(xhr) { console.log((xhr.loaded / xhr.total * 100) + '% loaded'); }
function onError(xhr) { console.log('An error happened'); }

function refreshARView() {
	location.reload(); // Reloads the page
}

function update() {
	if (arToolkitSource.ready !== false)
		arToolkitContext.update(arToolkitSource.domElement);
}

function render() {
	renderer.render(scene, camera);
}

function animate() {
	requestAnimationFrame(animate);
	deltaTime = clock.getDelta();
	totalTime += deltaTime;
	update();
	render();
}

// Refresh button event listener
document.addEventListener('DOMContentLoaded', function() {
	const button = document.createElement('button');
	button.className = 'refresh-button';
	button.innerText = 'Refresh';
	button.onclick = refreshARView;
	document.body.appendChild(button);
});
</script>

</body>
</html>
